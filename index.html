<html>

<head>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <title>ChordPicker</title>
    <script>
    </script>
    <script src="dist/bundle.js"></script>
    <script src="midi.js"></script>
    <style>
      #melodys {
        display: flex;
      }
      #melodys > div {
        display: flex;
        flex-direction: column;
        margin: 1px;
        width: 2rem;
      }
      #chords {
        display: flex;
      }
      .chord {
        display: flex;
        flex-direction: column;
        margin: 1px;
        width: 2rem;
      }
    </style>
</head>

<body>
    <div id="vue-template">
      <input type="text" v-model="melodyText"></input>
      <div id="melodys">
        <div v-for="note in melody">
          <p>{{ note.note }}<span v-if="note.sharp == -1">b</span><span v-if="note.sharp == 1">#</span></p>
          <input type="number" min="-1" max="1" v-model="note.sharp"></input>
          <select v-model="note.duration">
            <option value="w">Whole</option>
            <option value="h">Half</option>
            <option value="q">Quarter</option>
            <option value="e">Eighth</option>
            <option value="s">Sixteenth</option>
          </select>
          <input type="checkbox" v-model="note.dotted"></input>
        </div>
      </div>
      <div id="score">

      </div>
      <div id="chords">
        <div v-for="chordSlot in chordSlots">
          <div v-if="chords[chordSlot]">
            <div v-if="editingChord == chordSlot" class="editing-chord">
              <select v-model="selectedChordRoot">
                <option v-for="root in chordRootChoices" :value="root">{{ root }}</option>
              </select>
              <select v-if="selectedChordRoot != null" v-model="selectedChord">
                <option v-for="chord in chordInversionsAndDoublings[selectedChordRoot]" :value="chord">{{ chord.chord.chordType }} {{ chord.inversion }} {{ chord.doubling }}</option>
              </select>
              <button @click="saveChord()">OK</button>
            </div>
            <div v-else class="chord">
              <p>{{ chords[chordSlot].name }}</p>
              <p>{{ chords[chordSlot].numeral }}</p>
              <p>{{ chords[chordSlot].inversion }}</p>
              <button @click="startEditingChord(chordSlot)">E</button>
            </div>
          </div>
          <div v-else>
            <button @click="addChordToIndex(chordSlot)">+</button>
          </div>
        </div>
      </div>
      <button id="btn-play">PLAY</button>
      <button id="btn-pause">PAUSE</button>
      <button id="btn-stop">STOP</button>
    </div>
</body>
<script>

</script>
<script>
const { createApp } = Vue

createApp({
  data() {
    return {
      melodyText: "",
      melody: [],
      params: {},
      chords: {},
      editingChord: -1,
      chordChoices: [],
      selectedChordRoot: null,
      selectedChord: null,
    }
  },
  mounted() {
    this.params = new window.MainMusicParams();
  },
  computed: {
    maxDivision() {
      return this.melody.length * 12 + 24 * 12;
    },
    chordSlots() {
      ret = [];
      for (let i = 0; i < this.maxDivision; i += 12) {
        ret.push(i);
      }
      return ret;
    },
    chordToEdit() {
      return this.chords[this.editingChord];
    },
    chordRootChoices() {
      let ret = new Set();
      for (let i = 0; i < this.chordChoices.length; i++) {
        const chord = this.chordChoices[i];
        const rootName = chord.chord.notes[0].semitone;
        ret.add(rootName);
      }
      return Array.from(ret);
    },
    chordInversionsAndDoublings() {
      const ret = {};
      for (let i = 0; i < this.chordChoices.length; i++) {
        const chord = this.chordChoices[i];
        const rootName = chord.chord.notes[0].semitone;
        if (!ret[rootName]) {
          ret[rootName] = [];
        }
        ret[rootName].push(chord);
      }
      return ret;
    }
  },
  methods: {
    initMelodyNote(noteName) {
      return {
        'note': noteName,  // Can be a space or CDEFGAH
        'sharp': 0,
        'duration': 'q',
        'dotted': false,
      }
    },
    initChord() {
      return {
        'name': '',
        'numeral': '',
        'inversion': '',
        'doubling': '',
      }
    },
    refreshXML() {
      window.loadMelody(this.melody, this.chords, this.params)
    },
    addChordToIndex(index) {
      this.chords[index] = this.initChord();
      this.startEditingChord(index);
    },
    async startEditingChord(index) {
      let tmpIndex = index - 1;
      let prevChord = this.chords[tmpIndex];
      while (!prevChord && tmpIndex >= 0) {
        prevChord = this.chords[tmpIndex];
        tmpIndex--;
      }
      tmpIndex = index + 1;
      let nextChord = this.chords[tmpIndex];
      while (!nextChord && tmpIndex <= this.chordSlots[this.chordSlots.length - 1]) {
        nextChord = this.chords[tmpIndex];
        tmpIndex++;
      }
      this.editingChord = index;
      this.chordChoices = await window.getChordChoices(prevChord, nextChord, this.params);
    },
    saveChord() {
      this.chords[this.editingChord] = this.selectedChord;
      this.editingChord = -1;
      this.refreshXML();
    },
  },
  watch: {
    melodyText(newValue) {
      const newNotes = newValue.split("")
      if (this.melody.length < newNotes.length) {
        // Maybe new note is inserted in between
        for (let i = 0; i < newNotes.length; i++) {
          if (!this.melody[i] || this.melody[i].note != newNotes[i]) {
            this.melody.splice(i, 0, this.initMelodyNote(newNotes[i]))
          }
        }
      }
      else if (this.melody.length > newNotes.length) {
        // Maybe a note is deleted from the middle
        for (let i = 0; i < newNotes.length; i++) {
          if (this.melody[i].note != newNotes[i]) {
            this.melody.splice(i, 1)
          }
        }
      }
      // Check that noteName matches for each note
      for (let i = 0; i < newNotes.length; i++) {
        if (this.melody[i].note != newNotes[i]) {
          this.melody[i].note = newNotes[i]
          this.melody[i].sharp = 0
        }
      }
    },
    melody: {
      handler() {
        this.refreshXML();
      },
      deep: true,
    }
  }

}).mount('#vue-template')
</script>
</html>